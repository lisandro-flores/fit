<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0099ff">
    <title>Bit√°cora Semanal de Gimnasio - App</title>
    <style>
        /* --- CONFIGURACI√ìN BASE Y M√ìVIL (Mobile First) --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a; /* Fondo oscuro Smart Fit */
            color: #e0e0e0; /* Texto claro */
            margin: 0;
            padding: 0;
            padding-bottom: 70px; /* Espacio extra para el nav bar fijo */
            min-height: 10vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 1200px; 
            margin: 0 auto;
            background: #2a2a2a; /* Contenedor oscuro */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            min-height: calc(100vh - 70px); 
        }

        /* La clave para ocultar/mostrar secciones */
        .content-section {
            padding: 20px;
            display: none; /* Oculta todas las secciones por defecto */
            animation: fadeIn 0.3s ease-out;
        }

        .content-section.active {
            display: block; /* Muestra solo la secci√≥n con la clase 'active' */
        }

        /* T√≠tulos */
        h1 {
            padding: 20px;
            margin: 0;
            text-align: center;
            border-bottom: 1px solid #444; /* Borde oscuro */
            font-size: 2em;
            display: flex; /* Para controlar el color por palabra */
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        /* ESTILO ESPEC√çFICO PARA EL T√çTULO */
        #smart-word {
            color: #ffffff; /* Color blanco para 'SMART' */
            font-weight: bold;
        }
        #fit-word {
            color: #ffd700; /* Color amarillo Smart Fit para 'FIT ‚ö°Ô∏è Bit√°cora' */
            font-weight: bold;
        }

        h2 {
            color: #ffffff; /* Blanco para t√≠tulos de secci√≥n */
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 1.5em;
        }

        h3 {
            color: #e0e0e0; /* Gris claro para subt√≠tulos */
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px dashed #444; /* Borde oscuro */
            padding-bottom: 5px;
        }

        /* Animaci√≥n de entrada */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- FORMULARIO DE REGISTRO / COACH IA --- */
        .registro-form div {
            margin-bottom: 15px;
        }

        .registro-form label, #coach-ia-tab label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .registro-form input,
        .registro-form textarea,
        #coach-ia-tab input,
        #coach-ia-tab select,
        #gemini-input {
            width: 100%; 
            box-sizing: border-box; 
            padding: 10px;
            border: 1px solid #555; /* Borde oscuro */
            border-radius: 8px;
            font-size: 16px;
            background-color: #3a3a3a; /* Fondo de input oscuro */
            color: #e0e0e0; /* Texto de input claro */
        }

        .action-button {
            width: 100%;
            padding: 12px;
            color: #1a1a1a; /* Texto oscuro en botones amarillos */
            cursor: pointer;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        .register-button {
            background-color: #ffd700; /* Amarillo Smart Fit */
        }
        .register-button:hover {
            background-color: #e6c200; /* Amarillo m√°s oscuro al pasar el rat√≥n */
        }
        .gemini-button, .coach-button {
            background-color: #ffd700; /* Amarillo Smart Fit */
        }
        .gemini-button:hover, .coach-button:hover {
            background-color: #e6c200; /* Amarillo m√°s oscuro al pasar el rat√≥n */
        }
        
        /* --- ESTILOS DE LA SECCI√ìN GEMINI / COACH IA --- */
        #gemini-tab, #coach-ia-tab {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #gemini-input {
            min-height: 80px;
            resize: vertical;
        }

        #gemini-response-area, #coach-status-area {
            background-color: #3a3a3a; /* Fondo de respuesta oscuro */
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #ffd700; /* Borde amarillo */
            min-height: 50px;
            white-space: pre-wrap; 
            margin-top: 10px;
            color: #e0e0e0; /* Texto claro */
        }
        
        .loading-message {
            color: #ffd700; /* Amarillo Smart Fit */
            font-style: italic;
            text-align: center;
        }
        .success-message {
            color: #28a745; /* Verde para √©xito (mantener si se ve bien con el esquema) */
            font-weight: bold;
        }
        .error-message {
            color: #dc3545; /* Rojo para error */
            font-weight: bold;
        }

        .source-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .source-list li {
            margin-top: 5px;
            padding: 5px;
            border-bottom: 1px dotted #555; /* Borde oscuro */
        }
        .source-list a {
            color: #ffd700; /* Amarillo Smart Fit */
            text-decoration: none;
        }
        .source-list a:hover {
            text-decoration: underline;
        }

        /* --- NAV BAR INFERIOR FIJO (100% ANCHO) --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0; 
            width: 100%; 
            max-width: 100%;
            background-color: #1a1a1a; /* Fondo oscuro nav bar */
            display: flex; 
            justify-content: space-around;
            padding: 5px 0; 
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border-top: 1px solid #3a3a3a; /* Borde oscuro */
        }

        .nav-button {
            background: none;
            border: none;
            color: #888; /* Gris tenue para inactivo */
            padding: 5px 5px;
            cursor: pointer;
            text-align: center;
            flex-grow: 1;
            font-size: 14px; 
            transition: color 0.3s, background-color 0.3s;
            display: flex;
            flex-direction: column; 
            align-items: center;
        }

        .nav-button.active {
            color: #ffd700; /* Amarillo Smart Fit activo */
            font-weight: bold;
            background-color: #3a3a3a; /* Fondo m√°s claro para bot√≥n activo */
        }
        
        .nav-button .icon {
            display: block;
            font-size: 24px; 
            margin-bottom: 2px;
            filter: grayscale(100%) brightness(1.5); /* Iconos tenues por defecto */
            transition: filter 0.3s;
        }

        .nav-button.active .icon {
            filter: none; /* Iconos a color en activo (o amarillo, si se desea) */
            /* filter: sepia(100%) saturate(300%) hue-rotate(30deg) brightness(1.2); /* Esto podr√≠a ser una alternativa para hacerlos amarillos */
        }

        /* --- Estilos de Layout para Cards (General) --- */
        .card-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        /* --- Estilos para la Rutina del D√≠a (Cards Verdes a Amarillo/Negro) --- */
        .exercise-card {
            background-color: #3a3a3a; /* Fondo oscuro para card de ejercicio */
            border: 1px solid #ffd700; /* Borde amarillo */
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .exercise-card h4 {
            color: #ffd700; /* Amarillo Smart Fit para t√≠tulo de ejercicio */
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
            border-bottom: 2px solid #ffd700; /* Borde amarillo */
            padding-bottom: 5px;
        }

        .series-checklist {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #555; /* Borde oscuro */
        }

        .series-item {
            display: flex;
            align-items: center;
            background-color: #4a4a4a; /* Fondo de √≠tem de serie oscuro */
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #666; /* Borde m√°s oscuro */
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #e0e0e0; /* Texto claro */
        }

        .series-item:hover {
            background-color: #5a5a5a; /* Fondo m√°s claro al pasar el rat√≥n */
        }

        .series-item input[type="checkbox"] {
            margin-right: 5px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #ffd700; /* Checkbox amarillo */
        }
        
        .series-item input[type="checkbox"]:checked + span {
            text-decoration: line-through;
            color: #a0a0a0; /* Gris para texto tachado */
        }
        .p-message {
            text-align: center;
            padding: 20px;
            color: #a0a0a0; /* Gris para mensajes */
        }

        /* --- Estilos para la Planeaci√≥n Semanal (Cards Azules a Amarillo/Negro) --- */
        .weekly-card {
            background-color: #3a3a3a; /* Fondo oscuro para card semanal */
            border: 1px solid #ffd700; /* Borde amarillo */
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .weekly-card h4 {
            color: #ffd700; /* Amarillo Smart Fit para t√≠tulo semanal */
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
            border-bottom: 2px solid #ffd700; /* Borde amarillo */
            padding-bottom: 5px;
        }

        .weekly-card.current-day-highlight {
            border: 3px solid #ffd700; /* Borde amarillo m√°s grueso para d√≠a actual */
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
            background-color: #4a4a4a; /* Fondo ligeramente m√°s claro para d√≠a actual */
            transform: scale(1.02);
        }
        
        .weekly-card.rest-day {
            background-color: #2a2a2a; /* Fondo m√°s oscuro para d√≠a de descanso */
            border: 1px solid #666; /* Borde gris oscuro */
            color: #a0a0a0; /* Texto m√°s tenue */
        }

        /* Indicador de conexi√≥n (esquina superior derecha) */
        #online-indicator {
            position: absolute;
            top: 12px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.45);
            padding: 6px 10px;
            border-radius: 18px;
            border: 1px solid #333;
            color: #e0e0e0;
            font-size: 13px;
            z-index: 1100;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        #online-indicator .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745; /* verde */
            box-shadow: 0 0 6px rgba(40,167,69,0.6);
        }
        #online-indicator.offline .dot {
            background: #dc3545; /* rojo */
            box-shadow: 0 0 6px rgba(220,53,69,0.6);
        }
        #online-indicator.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- <button id="btn5min">Notificar en 5 min</button> -->

    <div class="container" style="position:relative;">
        <h1>
            <span id="smart-word">SMART</span>
            <span id="fit-word">FIT ‚ö°Ô∏è Bit√°cora</span>
        </h1>

        <!-- Indicador de conexi√≥n -->
        <div id="online-indicator" title="Estado de la conexi√≥n">
            <span class="dot"></span>
            <span id="online-text">Verificando...</span>
        </div>

        <div id="registrar-tab" class="content-section active">
            <h2>üìù Registrar Sesi√≥n</h2>
            <div class="registro-form">
                <div>
                    <label for="fecha">Fecha y Hora:</label>
                    <input type="text" id="fecha" readonly>
                </div>
                <div>
                    <label for="dia-semana">D√≠a de la Semana:</label>
                    <input type="text" id="dia-semana" readonly>
                </div>
                <div>
                    <label for="comentarios">Detalles / Comentarios:</label>
                    <textarea id="comentarios" rows="5" placeholder="Ej: 3 series de 10 repeticiones en press de banca. Me sent√≠ fuerte."></textarea>
                </div>
                <button onclick="registrarSesion()" class="action-button register-button">Guardar Sesi√≥n</button>
            </div>
        </div>

        

<div id="planeacion-tab" class="content-section">
            <h2 id="planeacion-main-title">üìã Mi Planeaci√≥n Semanal</h2>
            
            

<div style="margin-bottom: 25px; padding: 15px; border: 1px dashed #ffd700; border-radius: 8px;">
                <label for="fitness-idol" style="display: block; font-weight: bold; margin-bottom: 10px;">
                    Selecciona tu Inspiraci√≥n Semanal:
                </label>
                <select id="fitness-idol" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #555; margin-bottom: 10px; font-size: 16px; background-color: #3a3a3a; color: #e0e0e0;">
                    <option value="" disabled selected>Selecciona un √≠dolo fitness</option>
                    <option value="Carlos Belcast">Carlos Belcast (Fuerza)</option>
                    <option value="Andoni Fitness">Andoni Fitness (Powerbuilding/Fuerza)</option>
                    <option value="Joan Pradells">Joan Pradells (Bodybuilding)</option>
                    <option value="The Saiyan Kiwi">The Saiyan Kiwi (Fuerza/Est√©tica)</option>
                    <option value="Vikika Costa">Vikika Costa (Gl√∫teo/Funcional)</option>
                </select>
                
                <button onclick="descargarRutinaSeleccionada()" id="descarga-btn" class="action-button gemini-button" style="margin-top: 10px;">
                    Descargar Rutina Seleccionada
                </button>
            </div>

            

<div id="daily-routine-container">
                <h3 id="current-day-title">Rutina del D√≠a: Cargando...</h3>
                <div id="daily-routine-content" class="card-grid">
                    <p class="p-message">Cargando rutina o d√≠a de descanso.</p>
                </div>
            </div>

            

<h3 style="margin-top: 30px;">Planeaci√≥n Semanal Resumida</h3>
            <div id="weekly-overview-cards" class="card-grid">
                

</div>
            
            <p id="routine-note" style="margin-top: 20px; font-style: italic; color: #a0a0a0;"></p>
        </div>

        

<div id="bitacora-tab" class="content-section">
            <h2>üìú Historial de Sesiones</h2>
            <ul id="bitacora-list" style="color: #e0e0e0;">
                

</ul>
        </div>
        
        

<div id="gemini-tab" class="content-section">
            <h2>‚ú® Pregunta a Gemini (Fitness Coach)</h2>
            <p>Obt√©n consejos de entrenamiento, nutrici√≥n o informaci√≥n sobre ejercicios espec√≠ficos. ¬°Pregunta lo que necesites!</p>
            
            <textarea id="gemini-input" placeholder="Ej: ¬øCu√°les son 3 ejercicios para mejorar la sentadilla profunda?" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); askGemini(); }"></textarea>
            <button onclick="askGemini()" class="action-button gemini-button">
                Enviar Pregunta
            </button>
            
            <h3>Respuesta</h3>
            <div id="gemini-response-area">
                <p class="p-message">Las respuestas aparecer√°n aqu√≠. ¬°Preg√∫ntame algo!</p>
            </div>
        </div>

        

<div id="coach-ia-tab" class="content-section">
            <h2>üß† Coach IA: Generar Rutina R√°pida</h2>
            <p>Solicita una rutina de ejercicios personalizada para un grupo muscular o enfoque espec√≠fico. Se agregar√° a tu plan del d√≠a.</p>
            
            <div>
                <label for="muscle-group">Grupo Muscular o Enfoque:</label>
                <input type="text" id="muscle-group" placeholder="Ej: Pecho y Tr√≠ceps, o solo Gl√∫teos">
            </div>

            <button onclick="generateRoutine()" class="action-button coach-button">
                Generar y Agregar a la Rutina de Hoy
            </button>
            
            <h3>Estado</h3>
            <div id="coach-status-area">
                <p class="p-message">Ingresa tu enfoque muscular y haz clic en "Generar".</p>
            </div>
        </div>
    </div>

    

<nav class="nav-bar">
        <button class="nav-button active" onclick="showTab('registrar-tab', this)">
            <span class="icon">‚úçÔ∏è</span>
            Registrar
        </button>
        <button class="nav-button" onclick="showTab('planeacion-tab', this)">
            <span class="icon">üóìÔ∏è</span>
            Planeaci√≥n
        </button>
        <button class="nav-button" onclick="showTab('bitacora-tab', this)">
            <span class="icon">üìö</span>
            Bit√°cora
        </button>
        <button class="nav-button" onclick="showTab('gemini-tab', this)">
            <span class="icon">‚ú®</span>
            Gemini
        </button>
        <button class="nav-button" onclick="showTab('coach-ia-tab', this)">
            <span class="icon">üß†</span>
            Coach IA
        </button>
    </nav>


    <script>

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js");
        }
        // --- CONFIGURACI√ìN Y CONSTANTES ---
                // ...existing code...
        /**
         * Muestra solo la secci√≥n .content-section cuyo id coincida con `idToShow`
         * y oculta el resto.
         * @param {string} idToShow - id del elemento .content-section que debe mostrarse
         */
        function showOnlyContentSectionById(idToShow) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                if (section.id === idToShow) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // ...existing code...
        const STORAGE_KEY = 'bitacoraGymRegistros';
        const ROUTINE_KEY = 'carlosBelcastRoutine';
        
        // Base de la URL para todas las APIs de rutina
        const BASE_API_URL = 'https://studio--studio-9121294900-64a17.us-central1.hosted.app/';
        
        // Mapeo de valores del selector a los endpoints de la API
        const IDOL_ENDPOINTS = {
            "Carlos Belcast": "api/fitness/routines/carlos-belcast",
            "Andoni Fitness": "api/fitness/routines/andoni-fitness/",
            "Joan Pradells": "api/fitness/routines/joan-pradells/",
            "The Saiyan Kiwi": "api/fitness/routines/the-saiyan-kiwi/",
            "Vikika Costa": "api/fitness/routines/vikika-costa/",
        };



        // Funci√≥n auxiliar para fetch con reintentos
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Error en la API: ${response.statusText}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // Funci√≥n de navegaci√≥n: Muestra la pesta√±a seleccionada
        function showTab(tabId, buttonElement) {
            // Oculta todos los divs de contenido quitando la clase 'active'
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Muestra el div de contenido seleccionado agregando la clase 'active'
            document.getElementById(tabId).classList.add('active');

            // Actualiza el estado activo de los botones de navegaci√≥n
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');

            // Recargar datos solo si se navega a las pesta√±as de data
            if (tabId === 'bitacora-tab') {
                cargarBitacoraGuardada();
            }
            if (tabId === 'planeacion-tab') {
                const routineData = localStorage.getItem(ROUTINE_KEY);
                if (routineData) {
                    cargarRutinaEnAmbasTablas(JSON.parse(routineData));
                } else {
                    cargarRutinasPorDefecto(); 
                }
            }
            showOnlyContentSectionById(tabId);
        }

        // --- Funciones de Bit√°cora y Estado ---

        function cargarFechaYHora() {
            const now = new Date();
            const optionsFecha = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            
            const fechaString = now.toLocaleDateString('es-ES', optionsFecha);
            const diaSemanaString = diasSemana[now.getDay()];

            document.getElementById('fecha').value = fechaString;
            document.getElementById('dia-semana').value = diaSemanaString;
        }

        function renderizarRegistros(registros) {
            const bitacoraList = document.getElementById('bitacora-list');
            bitacoraList.innerHTML = ''; 
            
            if (registros.length === 0) {
                bitacoraList.innerHTML = '<li style="color: #a0a0a0;"><strong>¬°Empecemos!</strong> A√∫n no tienes sesiones registradas.</li>';
                return;
            }

            registros.slice().reverse().forEach(registro => {
                const nuevoRegistro = document.createElement('li');
                nuevoRegistro.innerHTML = `
                    <strong>${registro.diaSemana} - ${registro.fecha}</strong>
                    <p>${registro.comentarios}</p>
                `;
                bitacoraList.appendChild(nuevoRegistro); 
            });
        }

        function cargarBitacoraGuardada() {
            const registrosJSON = localStorage.getItem(STORAGE_KEY);
            let registros = registrosJSON ? JSON.parse(registrosJSON) : [];
            renderizarRegistros(registros);
        }

        function registrarSesion() {
            const fecha = document.getElementById('fecha').value;
            const diaSemana = document.getElementById('dia-semana').value;
            const comentarios = document.getElementById('comentarios').value;
            
            if (!comentarios.trim()) {
                console.error("Por favor, ingresa los detalles de tu sesi√≥n.");
                return;
            }
            
            const nuevoRegistro = {
                fecha: fecha,
                diaSemana: diaSemana,
                comentarios: comentarios.trim()
            };

            const registrosJSON = localStorage.getItem(STORAGE_KEY);
            let registros = registrosJSON ? JSON.parse(registrosJSON) : [];

            registros.push(nuevoRegistro);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
            
            document.getElementById('comentarios').value = '';
            cargarFechaYHora();

            console.log("¬°Sesi√≥n registrada con √©xito!");
        }

        // --- Funciones de Planeaci√≥n (Descarga y Manejo de Estado) ---
        
        function getCompletionKey(routine) {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            return `ROUTINE_COMPLETION_${today}_${routine.semana || 'Custom'}`;
        }
        
        window.toggleSeriesCompletion = function(checkbox, completionKey) {
            let completionState = JSON.parse(localStorage.getItem(completionKey)) || {};
            
            const exerciseIndex = checkbox.getAttribute('data-exercise-index');
            const seriesNum = checkbox.getAttribute('data-series-num');
            const uniqueId = `e${exerciseIndex}s${seriesNum}`; // Clave √∫nica simplificada
            
            completionState[uniqueId] = checkbox.checked;

            localStorage.setItem(completionKey, JSON.stringify(completionState));
        }


        // Carga la rutina del d√≠a en el formato de cards con checkboxes
        function cargarRutinaDelDia(diaHoy, routineData) {
            const dailyContent = document.getElementById('daily-routine-content');
            const currentDayTitle = document.getElementById('current-day-title');
            
            const todayRoutine = routineData.dias.find(d => d.dia.toLowerCase() === diaHoy.toLowerCase());
            
            const completionKey = getCompletionKey(routineData);
            let completionState = JSON.parse(localStorage.getItem(completionKey)) || {};

            dailyContent.innerHTML = ''; 

            if (todayRoutine && todayRoutine.ejercicios.length > 0) {
                currentDayTitle.textContent = `Rutina del D√≠a: ${todayRoutine.dia} (${todayRoutine.enfoque})`;
                
                todayRoutine.ejercicios.forEach((ej, index) => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card';
                    
                    let checklistHTML = '<div class="series-checklist">';
                    const numSeries = parseInt(ej.series);

                    for (let i = 1; i <= numSeries; i++) {
                        const uniqueSeriesId = `e${index}s${i}`;
                        const isChecked = completionState[uniqueSeriesId] === true;

                        checklistHTML += `
                            <label for="${uniqueSeriesId}" class="series-item">
                                <input type="checkbox" id="${uniqueSeriesId}" 
                                       data-exercise-index="${index}" 
                                       data-series-num="${i}" 
                                       ${isChecked ? 'checked' : ''} 
                                       onchange="toggleSeriesCompletion(this, '${completionKey}')">
                                <span>Serie ${i}</span>
                            </label>
                        `;
                    }
                    checklistHTML += '</div>';

                    card.innerHTML = `
                        <h4>${ej.nombre}</h4>
                        <p><strong>Series:</strong> ${ej.series} | <strong>Repeticiones:</strong> ${ej.repeticiones}</p>
                        ${checklistHTML}
                    `;
                    dailyContent.appendChild(card);
                });

            } else {
                currentDayTitle.textContent = `Rutina del D√≠a: ${diaHoy} (Descanso o Vac√≠a)`;
                dailyContent.innerHTML = '<p class="p-message">¬°Hoy es d√≠a de descanso o a√∫n no tienes ejercicios! Genera una rutina con el Coach IA o descarga una planeaci√≥n.</p>';
            }
        }

        // Carga la planeaci√≥n semanal resumida
        function cargarPlaneacionSemanal(routineData) {
            const weeklyCardsContainer = document.getElementById('weekly-overview-cards');
            weeklyCardsContainer.innerHTML = ''; 

            const order = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
            const daysMap = new Map();
            
            routineData.dias.forEach(diaData => {
                daysMap.set(diaData.dia, {
                    enfoque: diaData.enfoque,
                    duracion: `${diaData.duracion_sugerida_min || '??'} min`,
                    isRest: false,
                    exerciseCount: diaData.ejercicios.length
                });
            });

            if (routineData.descanso) {
                daysMap.set(routineData.descanso, {
                    enfoque: "D√≠a de Descanso",
                    duracion: "Recuperaci√≥n.",
                    isRest: true,
                    exerciseCount: 0
                });
            }
            
            const today = new Date();
            const diaHoy = diasSemana[today.getDay()];
            
            order.forEach(diaKey => {
                const data = daysMap.get(diaKey);
                
                if (data) {
                    const card = document.createElement('div');
                    let cardClass = 'weekly-card';
                    if (diaKey === diaHoy) {
                        cardClass += ' current-day-highlight';
                    } else if (data.isRest) {
                        cardClass += ' rest-day';
                    }
                    card.className = cardClass;
                    
                    const enfoqueText = data.isRest ? data.enfoque : `Enfoque: ${data.enfoque}`;
                    const exerciseCountText = data.exerciseCount > 0 ? `(${data.exerciseCount} ejercicios)` : '';

                    card.innerHTML = `
                        <h4>${diaKey}</h4>
                        <p><strong>${enfoqueText}</strong> ${exerciseCountText}</p>
                        <p>Duraci√≥n: ${data.duracion}</p>
                    `;
                    weeklyCardsContainer.appendChild(card);
                }
            });
        }

        // Carga ambas tablas (la del d√≠a y la semanal)
        function cargarRutinaEnAmbasTablas(routine) {
            const mainTitle = document.getElementById('planeacion-main-title');
            const noteP = document.getElementById('routine-note');

            mainTitle.textContent = `üìã Rutina: ${routine.semana || 'Planeaci√≥n'}`;
            noteP.innerHTML = `**Nota del Entrenador:** ${routine.nota_estilo || 'Rutina personalizada.'}`;

            const today = new Date();
            const diaHoy = diasSemana[today.getDay()];
            
            cargarRutinaDelDia(diaHoy, routine);
            cargarPlaneacionSemanal(routine);
        }
        
        // Carga las rutinas por defecto 
        function cargarRutinasPorDefecto() {
            const defaultRoutine = {
                semana: "Planeaci√≥n Inicial",
                nota_estilo: "Esta es tu planeaci√≥n pre-cargada. Los ejercicios que a√±adas con el Coach IA se guardar√°n aqu√≠.",
                dias: [
                    { dia: "Lunes", enfoque: "Full Body (Descarga una para detalles)", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "Martes", enfoque: "Cardio", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "Mi√©rcoles", enfoque: "H√≠brido", duracion_sugerida_min: 30, ejercicios: [] },
                    { dia: "Jueves", enfoque: "Pierna/Fuerza", duracion_sugerida_min: 65, ejercicios: [] },
                    { dia: "Viernes", enfoque: "Pecho y Espalda", duracion_sugerida_min: 60, ejercicios: [] },
                    { dia: "S√°bado", enfoque: "Circuito/Deporte", duracion_sugerida_min: 60, ejercicios: [] },
                ],
                descanso: "Domingo"
            };
            localStorage.setItem(ROUTINE_KEY, JSON.stringify(defaultRoutine));
            cargarRutinaEnAmbasTablas(defaultRoutine);
        }


        // Funci√≥n principal para descargar la rutina seleccionada
        async function descargarRutinaSeleccionada() {
            const select = document.getElementById('fitness-idol');
            const selectedIdol = select.value;

            if (!selectedIdol) {
                alert("Por favor, selecciona un √≠dolo fitness de la lista.");
                return;
            }

            const button = document.getElementById('descarga-btn');
            const originalText = button.textContent;
            button.textContent = 'Descargando...';
            button.disabled = true;

            const endpoint = IDOL_ENDPOINTS[selectedIdol];
            const fullUrl = BASE_API_URL + endpoint;
            
            try {
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} en la URL: ${fullUrl}`);
                }
                
                const routineData = await response.json();
                
                // A√±adir el nombre del √≠dolo como el nombre de la rutina si no tiene uno
                if (!routineData.semana) {
                    routineData.semana = `Rutina de ${selectedIdol}`;
                }

                localStorage.setItem(ROUTINE_KEY, JSON.stringify(routineData));
                cargarRutinaEnAmbasTablas(routineData);

                console.log(`Rutina de ${selectedIdol} descargada y cargada con √©xito.`);

            } catch (error) {
                console.error("Error al descargar la rutina:", error);
                alert(`Error al descargar la rutina de ${selectedIdol}. Revisa la consola.`);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        

        // Configuraci√≥n de la API de Gemini
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_API_KEY = "AIzaSyBkuIS0qQ7ogHIT34rSqawHdcpc_F6YiGY"; 
        const GEMINI_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        const QNA_SYSTEM_INSTRUCTION = "Act√∫a como un entrenador personal y nutricionista amigable y experto. Tu objetivo es proporcionar consejos de fitness, responder preguntas sobre rutinas, ejercicios y nutrici√≥n. Responde siempre de manera concisa y √∫til.";
        
        const ROUTINE_SYSTEM_INSTRUCTION = "Eres un generador de rutinas de fitness profesional. Crea una lista de 3 a 5 ejercicios efectivos para el enfoque muscular solicitado. Para cada ejercicio, proporciona un nombre, el n√∫mero de series sugeridas ('3', '4', etc.) y el rango de repeticiones sugeridas ('8-12', '10-15', etc.). DEBES RESPONDER √öNICAMENTE CON EL ARRAY JSON SOLICITADO, sin texto adicional.";

        // Mapeo de d√≠as de la semana de Date.getDay() a espa√±ol
        const diasSemana = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        
        // Esquema JSON para la rutina estructurada
        const routineSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "nombre": { "type": "STRING", description: "The name of the exercise, e.g., 'Sentadilla Profunda'." },
                    "series": { "type": "STRING", description: "Number of suggested sets, e.g., '3'." },
                    "repeticiones": { "type": "STRING", description: "Number of suggested reps, e.g., '8-12'." }
                },
                required: ["nombre", "series", "repeticiones"],
                propertyOrdering: ["nombre", "series", "repeticiones"]
            }
        };
        // --- FUNCI√ìN DE INTERACCI√ìN CON GEMINI (Q&A) ---
        async function askGemini() {
            const query = document.getElementById('gemini-input').value.trim();
            const responseArea = document.getElementById('gemini-response-area');
            
            if (!query) {
                responseArea.innerHTML = '<p class="p-message error-message">Por favor, ingresa una pregunta.</p>';
                return;
            }

            responseArea.innerHTML = '<p class="loading-message">Generando respuesta... ‚ú®</p>';
            document.getElementById('gemini-input').value = ''; 

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: QNA_SYSTEM_INSTRUCTION }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(GEMINI_BASE_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    let outputHTML = `<div>${text.replace(/\n/g, '<br>')}</div>`;
                    
                    if (sources.length > 0) {
                        outputHTML += '<h4 style="margin-top: 20px; color: #e0e0e0;">Fuentes:</h4>'; /* Subt√≠tulo fuentes */
                        outputHTML += '<ul class="source-list">';
                        sources.forEach(source => {
                            outputHTML += `<li><a href="${source.uri}" target="_blank">${source.title}</a></li>`;
                        });
                        outputHTML += '</ul>';
                    }

                    responseArea.innerHTML = outputHTML;

                } else {
                    responseArea.innerHTML = '<p class="error-message">Error: No se pudo obtener una respuesta v√°lida de Gemini. Int√©ntalo de nuevo.</p>';
                }

            } catch (error) {
                console.error("Error al comunicarse con la API de Gemini:", error);
                responseArea.innerHTML = '<p class="error-message">Ocurri√≥ un error al procesar tu solicitud. Revisa la consola para m√°s detalles.</p>';
            }
        }

        // --- FUNCI√ìN DE COACH IA (GENERACI√ìN DE RUTINA ESTRUCTURADA) ---
        async function generateRoutine() {
            const muscleGroup = document.getElementById('muscle-group').value.trim();
            const statusArea = document.getElementById('coach-status-area');
            
            if (!muscleGroup) {
                statusArea.innerHTML = '<p class="p-message error-message">Por favor, ingresa un grupo muscular o enfoque (Ej: Espalda).</p>';
                return;
            }

            statusArea.innerHTML = `<p class="loading-message">Generando rutina para: <strong>${muscleGroup}</strong>... üß†</p>`;
            
            const userQuery = `Genera una rutina de ejercicios de 3 a 5 ejercicios para el siguiente enfoque: ${muscleGroup}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: ROUTINE_SYSTEM_INSTRUCTION }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: routineSchema
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(GEMINI_BASE_URL, options);
                const result = await response.json();
                console.log("Respuesta de Gemini para rutina estructurada:", result);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const newExercises = JSON.parse(jsonText);
                    
                    if (newExercises.length > 0) {
                        // 1. Obtener la rutina actual
                        const routineJSON = localStorage.getItem(ROUTINE_KEY);
                        let routine = routineJSON ? JSON.parse(routineJSON) : null;

                        if (!routine) {
                            // Si no hay rutina base, cargar la por defecto
                            cargarRutinasPorDefecto();
                            const defaultRoutineJSON = localStorage.getItem(ROUTINE_KEY);
                            routine = JSON.parse(defaultRoutineJSON);
                        }

                        // 2. Encontrar el d√≠a de hoy
                        const today = new Date();
                        const diaHoy = diasSemana[today.getDay()];
                        
                        let currentDayRoutine = routine.dias.find(d => d.dia === diaHoy);
                        
                        if (!currentDayRoutine) {
                            // Si el d√≠a de hoy no existe en la rutina (raro, pero posible en la default), lo creamos.
                            currentDayRoutine = { dia: diaHoy, enfoque: muscleGroup, duracion_sugerida_min: 45, ejercicios: [] };
                            routine.dias.push(currentDayRoutine);
                        }
                        
                        // 3. Actualizar enfoque y fusionar ejercicios
                        currentDayRoutine.enfoque = `${currentDayRoutine.enfoque} + ${muscleGroup} (IA)`;
                        currentDayRoutine.ejercicios = [...currentDayRoutine.ejercicios, ...newExercises];
                        
                        // 4. Guardar y Recargar
                        localStorage.setItem(ROUTINE_KEY, JSON.stringify(routine));
                        cargarRutinaEnAmbasTablas(routine);
                        
                        statusArea.innerHTML = `
                            <p class="success-message">üéâ Rutina generada y agregada a tu plan de ${diaHoy}!</p>
                            <p style="color: #e0e0e0;">Ve a la pesta√±a üóìÔ∏è Planeaci√≥n para ver los ${newExercises.length} nuevos ejercicios.</p>
                        `;

                    } else {
                        statusArea.innerHTML = '<p class="error-message">El Coach IA no pudo generar ejercicios. Intenta con un enfoque diferente.</p>';
                    }

                } else {
                    statusArea.innerHTML = '<p class="error-message">Error: La respuesta de Gemini no contiene datos JSON v√°lidos. Int√©ntalo de nuevo.</p>';
                }

            } catch (error) {
                console.error("Error al generar la rutina:", error);
                statusArea.innerHTML = '<p class="error-message">Ocurri√≥ un error de conexi√≥n o procesamiento. Revisa la consola.</p>';
            }
        }


        // Ejecutar funciones al cargar la p√°gina
        window.onload = function() {
            cargarFechaYHora();

            const routineData = localStorage.getItem(ROUTINE_KEY);
            if (routineData) {
                cargarRutinaEnAmbasTablas(JSON.parse(routineData));
            } else {
                cargarRutinasPorDefecto();
            }
            
            cargarBitacoraGuardada();
            
            // Asegura que al cargar la p√°gina, solo est√© visible la pesta√±a 'Registrar'
            showTab('registrar-tab', document.querySelector('.nav-bar button:nth-child(1)'));
        };

        /**
         * Verifica si la app tiene acceso real a internet.
         * Usa navigator.onLine como primera aproximaci√≥n y realiza un ping a https://www.gstatic.com/generate_204
         * para confirmar conectividad real (timeout 3s).
         * @param {boolean} forcePing - cuando true fuerza el ping incluso si navigator.onLine === false
         * @returns {Promise<boolean>}
         */
        async function checkOnlineStatus(forcePing = false) {
            const indicator = document.getElementById('online-indicator');
            const textEl = document.getElementById('online-text');

            // Si navigator.reportar offline y no forzamos, marcamos offline r√°pido
            if (!navigator.onLine && !forcePing) {
                setOffline();
                return false;
            }

            // Intento de ping r√°pido para confirmar acceso real
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            try {
                const res = await fetch('https://studio--studio-9121294900-64a17.us-central1.hosted.app/api/hello', {
                    method: 'GET',
                    cache: 'no-store',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (res && (res.status === 204 || res.ok)) {
                    setOnline();
                    return true;
                } else {
                    setOffline();
                    return false;
                }
            } catch (err) {
                clearTimeout(timeoutId);
                setOffline();
                return false;
            }

            // helpers locales
            function setOnline() {
                indicator.classList.remove('offline', 'hidden');
                indicator.querySelector('.dot').style.background = '#28a745';
                textEl.textContent = 'En l√≠nea';
                indicator.title = 'Conexi√≥n OK';
            }
            function setOffline() {
                indicator.classList.add('offline');
                indicator.classList.remove('hidden');
                indicator.querySelector('.dot').style.background = '#dc3545';
                textEl.textContent = 'Sin conexi√≥n';
                indicator.title = 'Sin acceso a Internet';
            }
        }

        // Manejo de eventos online/offline del navegador
        window.addEventListener('online', () => {
            // cuando regresa la se√±al, confirmamos con un ping
            checkOnlineStatus(true);
        });
        window.addEventListener('offline', () => {
            // cambio inmediato visual cuando el navegador detecta offline
            const indicator = document.getElementById('online-indicator');
            if (indicator) {
                indicator.classList.add('offline');
                indicator.querySelector('.dot').style.background = '#dc3545';
                document.getElementById('online-text').textContent = 'Sin conexi√≥n';
                indicator.title = 'Sin acceso a Internet';
            }
        });

        // Verificaci√≥n peri√≥dica cada 30s (por si navigator.onLine est√° true pero no hay acceso real)
        const ONLINE_CHECK_INTERVAL_MS = 30000;
        setInterval(() => {
            checkOnlineStatus();
        }, ONLINE_CHECK_INTERVAL_MS);

        // Llamada inicial al cargar
        window.addEventListener('load', () => {
            checkOnlineStatus();
        });
        
    </script>
</body>
</html>